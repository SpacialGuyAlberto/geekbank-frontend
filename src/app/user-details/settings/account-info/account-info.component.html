<div class="account-info-dashboard">
  <div class="tabs-menu" *ngIf="!isSmallScreen">
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'details'}" (click)="selectTab('details')">
      <i class="fas fa-user"></i> Detalles de la Cuenta
    </button>
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'addresses'}" (click)="selectTab('addresses')">
      <i class="fas fa-map-marker-alt"></i> Direcciones
    </button>
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'payment'}" (click)="selectTab('payment')">
      <i class="fas fa-credit-card"></i> Métodos de Pago
    </button>
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'preferences'}" (click)="selectTab('preferences')">
      <i class="fas fa-cog"></i> Preferencias
    </button>
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'transactions'}"
      (click)="selectTab('transactions')">
      <i class="fas fa-money-check-alt"></i> Transacciones
    </button>
    <button class="tab-button" [ngClass]="{'active': selectedTab === 'wishList'}" (click)="selectTab('wishList')">
      <i class="fa-solid fa-heart"></i> Wish List
    </button>
    <button class="tab-button" *ngIf="user && user.role === 'ADMIN'"
      [ngClass]="{'active': selectedTab === 'admin-tools'}" (click)="selectTab('admin-tools')">
      <i class="fas fa-tools"></i> Herramientas de Admin
    </button>
  </div>

  <div class="content-grid">
    <!-- Detalles de la Cuenta -->
    <div class="content-section" *ngIf="selectedTab === 'details'">
      <h2>Detalles de la Cuenta</h2>
      <form (ngSubmit)="updatePersonalInfo()">
        <div class="field">
          <label for="name">Nombre Completo</label>
          <span *ngIf="!editingName" class="current-value">{{ user.name }}</span>
          <input *ngIf="editingName" type="text" id="name" [(ngModel)]="detailsBody.name" name="name" required
            minlength="2" maxlength="50" placeholder="Ingresa tu nombre" />
          <i class="fas fa-pencil-alt" (click)="toggleEdit('name')" title="Editar"></i>
          <div *ngIf="validationErrors.name" class="error-message">
            {{ validationErrors.name }}
          </div>
        </div>

        <div class="field">
          <label for="email">Correo Electrónico</label>
          <span *ngIf="!editingEmail" class="current-value">{{ user.email }}</span>
          <input *ngIf="editingEmail" type="email" id="email" [(ngModel)]="detailsBody.email" name="email" required
            placeholder="Ingresa tu email" />
          <i class="fas fa-pencil-alt" (click)="toggleEdit('email')" title="Editar"></i>
          <div *ngIf="validationErrors.email" class="error-message">
            {{ validationErrors.email }}
          </div>
        </div>

        <div class="field">
          <label for="phone">Teléfono</label>
          <span *ngIf="!editingPhone" class="current-value">{{ user.phone }}</span>
          <input *ngIf="editingPhone" type="tel" id="phone" [(ngModel)]="detailsBody.phoneNumber" name="phone" required
            pattern="[0-9]{10,15}" placeholder="Ingresa tu teléfono" />
          <i class="fas fa-pencil-alt" (click)="toggleEdit('phone')" title="Editar"></i>
          <div *ngIf="validationErrors.phoneNumber" class="error-message">
            {{ validationErrors.phoneNumber }}
          </div>
        </div>

        <div *ngIf="generalErrorMessage" class="error-message general-error">
          {{ generalErrorMessage }}
        </div>

        <div class="field">
          <label>Balance Actual</label>
          <span class="current-value" style="color: var(--success-color); font-weight: bold;">{{ user.balance |
            currency:'USD' }}</span>
        </div>

        <button type="submit" *ngIf="editingName || editingEmail || editingPhone">
          Guardar Cambios
        </button>
      </form>
      <div *ngIf="showSuccessMessage" class="success-message">
        Información actualizada exitosamente.
      </div>

      <div class="danger-zone">
        <h3>Zona de Peligro</h3>
        <p>Una vez que elimines tu cuenta, no hay vuelta atrás. Por favor, asegúrate.</p>
        <button type="button" (click)="deleteAccount()">
          Eliminar Cuenta
        </button>
      </div>
    </div>

    <div class="content-section" *ngIf="selectedTab === 'addresses'">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
        <h2 style="margin: 0; border: none; padding: 0;">Direcciones</h2>
        <button (click)="addNewAddress()" style="margin: 0; padding: 0.5rem 1rem; width: auto; font-size: 0.9rem;">
          <i class="fas fa-plus"></i> Nueva
        </button>
      </div>

      <div *ngIf="user.addresses.length === 0" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
        No tienes direcciones guardadas.
      </div>

      <ul>
        <li *ngFor="let address of user.addresses">
          <div style="display: flex; flex-direction: column;">
            <span style="font-weight: 600; color: var(--text-main);">{{ address.street }}</span>
            <span style="font-size: 0.85rem; color: var(--text-secondary);">{{ address.city }}, {{ address.country }} -
              {{
              address.zipCode }}</span>
          </div>
          <div>
            <i class="fas fa-trash" (click)="deleteAddress(address)" title="Eliminar"></i>
          </div>
        </li>
      </ul>
    </div>

    <div class="content-section" *ngIf="selectedTab === 'payment'">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
        <h2 style="margin: 0; border: none; padding: 0;">Métodos de Pago</h2>
        <button (click)="addNewPaymentMethod()"
          style="margin: 0; padding: 0.5rem 1rem; width: auto; font-size: 0.9rem;">
          <i class="fas fa-plus"></i> Nuevo
        </button>
      </div>

      <div *ngIf="user.paymentOptions.length === 0"
        style="text-align: center; color: var(--text-secondary); padding: 2rem;">
        No tienes métodos de pago guardados.
      </div>

      <ul>
        <li *ngFor="let payment of user.paymentOptions">
          <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-credit-card" style="font-size: 1.5rem; color: var(--text-secondary);"></i>
            <div style="display: flex; flex-direction: column;">
              <span style="font-weight: 600; color: var(--text-main);">{{ payment.type }} **** {{ payment.lastFourDigits
                }}</span>
              <span style="font-size: 0.85rem; color: var(--text-secondary);">{{ payment.provider }}</span>
            </div>
          </div>
          <div>
            <i class="fas fa-trash" (click)="deletePaymentMethod(payment)" title="Eliminar"></i>
          </div>
        </li>
      </ul>
    </div>

    <div class="content-section" *ngIf="selectedTab === 'preferences'">
      <h2>Preferencias de Comunicación</h2>
      <form (ngSubmit)="updateCommunicationPreferences()">
        <div class="preference-item">
          <label for="promocheck">Recibir Promociones y Ofertas</label>
          <input type="checkbox" id="promocheck" [(ngModel)]="user.preferences.promotions" name="promotions" />
        </div>

        <div class="preference-item">
          <label for="ordercheck">Recibir Actualizaciones de Pedidos</label>
          <input type="checkbox" id="ordercheck" [(ngModel)]="user.preferences.orderUpdates" name="orderUpdates" />
        </div>

        <div style="margin-top: 2rem;">
          <button type="submit">Actualizar Preferencias</button>
        </div>
      </form>
      <div *ngIf="showSuccessMessage" class="success-message">
        Preferencias actualizadas exitosamente.
      </div>
    </div>

    <div class="content-section" *ngIf="selectedTab === 'transactions'">
      <app-orders></app-orders>
    </div>

    <div class="content-section" *ngIf="selectedTab === 'wishList'">
      <app-wishlist></app-wishlist>
    </div>

    <div class="content-section admin-tools" *ngIf="selectedTab === 'admin-tools' && user.role === 'ADMIN'">
      <h2>Herramientas de Administrador</h2>
      <ul>
        <li>
          <a (click)="navigateToAdminPanel()"
            style="cursor: pointer; display: flex; align-items: center; gap: 1rem; color: var(--text-main); text-decoration: none;">
            <i class="fas fa-tools" style="color: var(--accent-primary);"></i>
            <span>Panel de Administración</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<div *ngIf="generalErrorMessage" class="error-message general-error">
  {{ generalErrorMessage }}
</div>

<app-password-modal *ngIf="showPasswordModal" [detailsBody]="detailsBody" [user]="user"
  (onConfirm)="handlePasswordModalResponse($event)"></app-password-modal>