<!-- tigo-payment.component.html -->

<div class="modal" *ngIf="showModal">
  <div class="modal-content">
    <span class="close" (click)="handleClose()">&times;</span>
    <h2>Express Tigo Checkout</h2>

    <!-- Spinner de carga personalizado -->
    <div *ngIf="showSpinner" class="loading-indicator">
      <div class="bars">
        <div class="bar bar1"></div>
        <div class="bar bar2"></div>
        <div class="bar bar3"></div>
        <div class="bar bar4"></div>
        <div class="bar bar5"></div>
      </div>
      <p>Cargando, por favor espere...</p>
    </div>

    <!-- Paso 1: Ingresar Número de Referencia -->
    <ng-container *ngIf="step === 1 && !showSpinner">
      <h3>1. Ingresa tu número de referencia</h3>
      <div class="form-group">
        <label for="refNumber">Número de Referencia</label>
        <input
          type="text"
          id="refNumber"
          [(ngModel)]="manualVerificationData.refNumber"
          name="refNumber"
          class="retro-input"
        />
      </div>
      <p class="error-message" *ngIf="manualVerificationError">
        {{ manualVerificationError }}
      </p>
      <div class="button-group">
        <button class="primary-button" (click)="goToStep2AfterRef()">Continuar</button>
        <button class="cancel-button" (click)="closeModal()">Cancelar</button>
      </div>
    </ng-container>

    <!-- Paso 2: Email, SMS y Teléfono -->
    <ng-container *ngIf="step === 2 && !showSpinner">
      <h3>2. Opciones de envío de la clave</h3>

      <!-- Input de Email -->
      <div class="form-group">
        <label for="emailForKey">Correo Electrónico</label>
        <input
          type="email"
          id="emailForKey"
          [(ngModel)]="emailForKey"
          name="emailForKey"
          class="retro-input"
        />
      </div>

      <!-- Input de Teléfono -->
      <div class="form-group">
        <label for="phoneNumber">Teléfono</label>
        <input
          type="tel"
          id="phoneNumber"
          [(ngModel)]="paymentDetails.phoneNumber"
          name="phoneNumber"
          class="retro-input"
        />
      </div>

      <!-- Checkbox de SMS -->
      <div class="form-group">
        <label class="custom-checkbox">
          <input
            type="checkbox"
            [(ngModel)]="wantsSMSKey"
            name="wantsSMSKey"
          />
          <span class="checkmark"></span>
          Mandar código por SMS
          <span class="sms-cost">(Costo extra: 1 Lps)</span>
        </label>
      </div>

      <p class="error-message" *ngIf="errorMessage">{{ errorMessage }}</p>

      <div class="button-group">
        <button class="primary-button" (click)="goToStep3AfterEmailSms()">
          Continuar
        </button>
        <button class="cancel-button" (click)="closeModal()">Cancelar</button>
      </div>
    </ng-container>

    <!-- Paso 3: Resumen de la orden (productos, precio, email, sms, teléfono) -->
    <ng-container *ngIf="step === 3 && !showSpinner">
      <h3 style="display: flex; align-items: center; justify-content: space-between;">
        3. Resumen de tu orden

        <!-- Botón de edición que nos regresa al paso 2 -->
        <button class="edit-button" (click)="step = 2" title="Editar datos de envío">
          <i class="fa-solid fa-pen-to-square"></i>
          Editar
        </button>
      </h3>

      <!-- Si existe productId, es un solo producto. Si hay cartItems, se listan. -->
      <div *ngIf="productId !== null; else multipleCart">
        <p>Has seleccionado un producto con ID: {{ productId }}</p>
        <p>Cantidad: 1</p>
        <p>Precio: L {{ totalPrice }}</p>
      </div>

      <ng-template #multipleCart>
        <div *ngIf="cartItems && cartItems.length > 0; else noItems">
          <h4>Productos en el carrito:</h4>
          <div *ngFor="let item of cartItems">
            <p>
              {{ item.giftcard.name }}
              (x {{ item.cartItem.quantity }})
              => L {{ item.giftcard.priceHNL * item.cartItem.quantity }}
            </p>
          </div>
          <p><strong>Total:</strong> L {{ totalPrice }}</p>
        </div>
        <ng-template #noItems>
          <p>No hay items en el carrito.</p>
        </ng-template>
      </ng-template>

      <hr />

      <!-- Mostramos el email, teléfono y si seleccionó SMS -->
      <p><strong>Email:</strong> {{ emailForKey || 'No ingresado' }}</p>
      <p><strong>Teléfono:</strong>
        <span *ngIf="paymentDetails.phoneNumber && paymentDetails.phoneNumber !== ''">
      {{ paymentDetails.phoneNumber }}
    </span>
        <span *ngIf="!paymentDetails.phoneNumber || paymentDetails.phoneNumber === ''">
      No ingresado
    </span>
      </p>
      <p><strong>SMS:</strong>
        <span *ngIf="wantsSMSKey">Sí (se enviará al teléfono anterior)</span>
        <span *ngIf="!wantsSMSKey">No</span>
      </p>

      <hr />
      <p class="error-message" *ngIf="manualVerificationError">{{ manualVerificationError }}</p>

      <div class="button-group">
        <!-- Al presionar, disparamos la verificación final -->
        <button class="primary-button" (click)="goToStep4ConfirmVerification()">
          Continuar
        </button>
        <button class="cancel-button" (click)="closeModal()">Cancelar</button>
      </div>
    </ng-container>


    <!-- Paso 4: Resultado o Mensajes finales (Spinner activo o estado de la transacción) -->
    <ng-container *ngIf="step === 4">
      <!-- Mensaje de verificación en proceso o final -->
      <div *ngIf="isPaymentVerified && manualVerificationSuccess">
        <p class="success-message">{{ manualVerificationSuccess }}</p>
      </div>

      <!-- Mensaje de error de verificación -->
      <div *ngIf="!isPaymentVerified && manualVerificationError">
        <p class="error-message">{{ manualVerificationError }}</p>
      </div>

      <!-- Mostrar resultados de la transacción -->
      <div *ngIf="transactionStatus === 'COMPLETED' || transactionStatus === 'AWAITING_MANUAL_PROCESSING' || transactionStatus === 'PROCESSING'">
        <div *ngIf="transactionStatus === 'AWAITING_MANUAL_PROCESSING' || transactionStatus === 'PROCESSING'">
          <h3>¡Gracias por verificar tu pago!</h3>
          <p>Su transacción está siendo procesada. En breve recibirás tu código en tu email.</p>
          <button type="button" class="primary-button" (click)="closeModal()">Cerrar</button>
        </div>

        <!-- Detalles de pago no coincidente -->
        <div *ngIf="paymentReferenceNumber && unmatchedPaymentResponse">
          <h3>Detalles del Pago</h3>
          <p><strong>Número de referencia:</strong> {{ unmatchedPaymentResponse.unmatchedPayment.referenceNumber }}</p>
          <p><strong>Teléfono:</strong> {{ unmatchedPaymentResponse.unmatchedPayment.phoneNumber }}</p>
          <p><strong>Monto recibido:</strong> {{ unmatchedPaymentResponse.receivedAmount }}</p>
          <p><strong>Monto esperado:</strong> {{ unmatchedPaymentResponse.expectedAmount }}</p>
          <p><strong>Diferencia:</strong> {{ unmatchedPaymentResponse.difference }}</p>
          <p><strong>Mensaje:</strong> {{ unmatchedPaymentResponse.message }}</p>

          <div *ngIf="unmatchedPaymentResponse.options && unmatchedPaymentResponse.options.length > 0">
            <h4>Opciones</h4>
            <div class="button-group">
              <button class="option-button" *ngFor="let option of unmatchedPaymentResponse.options" (click)="handleOptionSelection(option)">
                {{ option }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje de monto insuficiente -->
      <p>{{ insufficientPaymentAmount }}</p>
      <ng-container *ngIf="showInsufficientPaymentAmount">
        <!-- Contenido adicional si es necesario -->
      </ng-container>

      <!-- Estado de transacción cancelada -->
      <ng-container *ngIf="transactionStatus === 'CANCELLED'">
        <div class="cancelled-message">
          <h3>Producto no disponible</h3>
          <p>El producto que intentas comprar no está disponible por el momento. Intente más tarde.</p>
          <button type="button" class="primary-button" (click)="reloadPage()">
            <i class="fa-solid fa-arrows-rotate"></i> Reintentar
          </button>
        </div>
      </ng-container>

      <!-- Mensajes de éxito/error generales -->
      <div *ngIf="successMessage" class="success-message">
        {{ successMessage }}
      </div>
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
      </div>
    </ng-container>
  </div>
</div>

<!-- Modal de autenticación (opcional) -->
<app-auth-modal
  *ngIf="false"
  (close)="handleAuthModalClose()"
  (authenticated)="handleAuthSuccess()"
></app-auth-modal>
